

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Tutorial &mdash; OpenPiv v1 documentation</title>
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="OpenPiv v1 documentation" href="../index.html" />
    <link rel="next" title="API reference" href="api_reference.html" />
    <link rel="prev" title="Information for developers and contributors" href="developers.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="api_reference.html" title="API reference"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="developers.html" title="Information for developers and contributors"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">OpenPiv v1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h1>
<p>This tutorial focuses on the use of the openpiv python module for scripting. This tutorial only shows some of the most commonly used features of
OpenPiv. Check the complete API reference at <a class="reference internal" href="api_reference.html#api-reference"><em>API reference</em></a></p>
<p>First step is to install OpenPiv. For installation details
on various platforms see <a class="reference internal" href="installation_instruction.html#installation-instruction"><em>Installation instruction</em></a>.</p>
<p>This tutorial uses some of the example data provided with the source distribution
of OpenPiv that you can find in our <a class="reference external" href="https://github.com/alexlib/OpenPiv">GitHub repository</a>.</p>
<div class="section" id="first-example-how-to-process-an-image-pair">
<h2>First example: how to process an image pair<a class="headerlink" href="#first-example-how-to-process-an-image-pair" title="Permalink to this headline">¶</a></h2>
<p>Here is a complete working example showing how to process an image pair.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">openpiv.tools</span>
<span class="kn">import</span> <span class="nn">openpiv.pyprocess</span>
<span class="kn">import</span> <span class="nn">openpiv.scaling</span>

<span class="n">frame_a</span>  <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span> <span class="s">&#39;exp1_001_a.bmp&#39;</span> <span class="p">)</span>
<span class="n">frame_b</span>  <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span> <span class="s">&#39;exp1_001_b.bmp&#39;</span> <span class="p">)</span>

<span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">pyprocess</span><span class="o">.</span><span class="n">piv</span><span class="p">(</span> <span class="n">frame_a</span><span class="p">,</span> <span class="n">frame_b</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">sig2noise_lim</span><span class="o">=</span><span class="mf">1.5</span> <span class="p">)</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">pyprocess</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span> <span class="n">image_size</span><span class="o">=</span><span class="n">frame_a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">32</span> <span class="p">)</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">scaling</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">scaling_factor</span> <span class="o">=</span> <span class="mf">1236.6</span> <span class="p">)</span>

<span class="n">openpiv</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s">&#39;exp1_001.txt&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We first import some of the openpiv modules.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">openpiv.tools</span>
<span class="kn">import</span> <span class="nn">openpiv.pyprocess</span>
<span class="kn">import</span> <span class="nn">openpiv.scaling</span>
</pre></div>
</div>
<p>Module <tt class="docutils literal"><span class="pre">openpiv.tools</span></tt> contains mostly contains utilities and tools, such as file I/O and multiprocessing
facilities. Module <tt class="docutils literal"><span class="pre">openpi.pyprocess</span></tt> contains a pure Python implementation of the PIV cross-correlation
algorithm and several helper functions. Last, module <tt class="docutils literal"><span class="pre">openpiv.scaling</span></tt> contains function for field scaling
and plate calibration stuff.</p>
<p>We then load the two image files into numpy arrays:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">frame_a</span>  <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span> <span class="s">&#39;exp1_001_a.bmp&#39;</span> <span class="p">)</span>
<span class="n">frame_b</span>  <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span> <span class="s">&#39;exp1_001_b.bmp&#39;</span> <span class="p">)</span>
</pre></div>
</div>
<p>In this example we use the pure python implementation to get the velocity field from the image pair.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">pyprocess</span><span class="o">.</span><span class="n">piv</span><span class="p">(</span> <span class="n">frame_a</span><span class="p">,</span> <span class="n">frame_b</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">sig2noise_lim</span><span class="o">=</span><span class="mf">1.5</span> <span class="p">)</span>
</pre></div>
</div>
<p>The function <tt class="xref py py-func docutils literal"><span class="pre">openpiv.pyprocess.piv()</span></tt> is a python implementation of the standard cross-correlation
algorithm. We also provide some options to the function, namely the <tt class="docutils literal"><span class="pre">window_size</span></tt>, i.e. the size of the
interrogation windows, the <tt class="docutils literal"><span class="pre">overlap</span></tt> between the windows in pixels and the time delay in seconds <tt class="docutils literal"><span class="pre">dt</span></tt> between
the two image frames. <tt class="docutils literal"><span class="pre">sig2noise_lim</span></tt> is the lower limit for the signal to noise ratio accepted before a vector is considered
an outlier.</p>
<p>We then compute the coordinates of the centers of the interrogation windows using <tt class="xref py py-func docutils literal"><span class="pre">openpiv.pyprocess.get_coordinates()</span></tt>.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">pyprocess</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span> <span class="n">image_size</span><span class="o">=</span><span class="n">frame_a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">32</span> <span class="p">)</span>
</pre></div>
</div>
<p>Note that we have provided some the same options we have given in the previuos command.</p>
<p>Then we apply an uniform scaling with the function <tt class="xref py py-func docutils literal"><span class="pre">openpiv.scaling.uniform()</span></tt> providing the <tt class="docutils literal"><span class="pre">scaling_factor</span></tt> value, in pixels per meters
if we want position and velocities in meters and meters/seconds or in pixels per millimeters if we want positions and velocities in millimeters and millimeters/seconds, respectively.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">scaling</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">scaling_factor</span> <span class="o">=</span> <span class="mf">1236.6</span> <span class="p">)</span>
</pre></div>
</div>
<p>Finally we save the data to an ascii file, for later processing, using::</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">openpiv</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s">&#39;exp1_001.txt&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="second-example-how-to-process-in-batch-a-list-of-image-pairs">
<h2>Second example: how to process in batch a list of image pairs.<a class="headerlink" href="#second-example-how-to-process-in-batch-a-list-of-image-pairs" title="Permalink to this headline">¶</a></h2>
<p>It if often the case, where several hundreds of image pairs have been sampled
in an experiment and have to be processed. For these tasks it is easier to
launch the analysis in batch and process all the image pairs
with the same processing parameters. OpenPiv, with its powerful python
scripting capabilities, provides a convenient way to
accomplish this task and offers multiprocessing facilities for machines
which have multiple cores, to speed up the computation. Since the analysis
is an embarassingly parallel problem, the speed up that can be reached
is quite high and almost equal to the number of core your machine has.</p>
<p>Compared to the previous example we have to setup some more things in the python
script we will use for the batch processing.</p>
<p>Let&#8217;s first import the needed modules.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">openpiv.tools</span>
<span class="kn">import</span> <span class="nn">openpiv.scaling</span>
<span class="kn">import</span> <span class="nn">openpiv.pyprocess</span>
</pre></div>
</div>
<p>We then define a python function which will be excecuted for each image pair.
Here it is::</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">func</span><span class="p">(</span> <span class="n">args</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A function to process each image pair.&quot;&quot;&quot;</span>

    <span class="c"># this line is REQUIRED for the multiprocessing to work</span>
    <span class="c"># always use it in your custom function</span>

    <span class="n">file_a</span><span class="p">,</span> <span class="n">file_b</span><span class="p">,</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">args</span>


    <span class="c">#####################</span>
    <span class="c"># Here goes you code</span>
    <span class="c">#####################</span>

    <span class="c"># read images into numpy arrays</span>
    <span class="n">frame_a</span>  <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span> <span class="n">file_a</span> <span class="p">)</span>
    <span class="n">frame_b</span>  <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span> <span class="n">file_b</span> <span class="p">)</span>

    <span class="c"># process image pair with the purepython implementation</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">extended_search_area_piv</span><span class="p">(</span> <span class="n">frame_a</span><span class="p">,</span> <span class="n">frame_b</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">search_area_size</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">3</span> <span class="p">)</span>

    <span class="c"># get window centers coordinates</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">pyprocess</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span> <span class="n">image_size</span><span class="o">=</span><span class="n">frame_a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mi">12</span> <span class="p">)</span>

    <span class="c"># get flow field in dimensional units: 1236.6 are pixels per millimiters so x, y, u, v will be in millimeters and millimeters/seconds</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">scaling</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">scaling_factor</span> <span class="o">=</span> <span class="mf">16.7</span> <span class="p">)</span>

    <span class="c"># save to a file</span>
    <span class="n">openpiv</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s">&#39;exp1_</span><span class="si">%03d</span><span class="s">.txt&#39;</span> <span class="o">%</span> <span class="n">counter</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%8.7f</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="p">)</span>
</pre></div>
</div>
<p>The function we have written <em>must</em> accept in input a single argument. This argument is a three element tuple, which
you have to unpack in the function as we have done with:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">file_a</span><span class="p">,</span> <span class="n">file_b</span><span class="p">,</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">args</span>
</pre></div>
</div>
<p>The tuple contains the two filenames of the image pair and a counter, which is needed to remember which image pair
we are currently processing, (basically just for the output filename). After that you have unpacked the tuple into
its three elements, you can use them to load the images and do the rest.</p>
<p>This is just half of the job. In the same script we are going to write the following two lines of code.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">task</span> <span class="o">=</span> <span class="n">openpiv</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">Multiprocesser</span><span class="p">(</span> <span class="n">data_dir</span> <span class="o">=</span> <span class="s">&#39;/home/User/images&#39;</span><span class="p">,</span> <span class="n">pattern_a</span><span class="o">=</span><span class="s">&#39;2image_*0.tif&#39;</span><span class="p">,</span> <span class="n">pattern_b</span><span class="o">=</span><span class="s">&#39;2image_*1.tif&#39;</span> <span class="p">)</span>
<span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span> <span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">,</span> <span class="n">n_cpus</span><span class="o">=</span><span class="mi">8</span> <span class="p">)</span>
</pre></div>
</div>
<p>The first line creates an instance of the <tt class="xref py py-func docutils literal"><span class="pre">Openpiv.tools.Multiprocesser()</span></tt> class. To construct the class
you have to pass three arguments:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">data_dir</span></tt>: the directory where image files are located</li>
<li><tt class="docutils literal"><span class="pre">pattern_a</span></tt> and <tt class="docutils literal"><span class="pre">pattern_b</span></tt>: the patterns for matching image files for frames <cite>a</cite> and <cite>b</cite>.</li>
</ul>
<p>The second line actually launch the batch process, using for each image pair the <tt class="docutils literal"><span class="pre">func</span></tt> function we have provided. Note that we have set the <tt class="docutils literal"><span class="pre">n_cpus</span></tt> option
to be equal to <tt class="docutils literal"><span class="pre">8</span></tt> becasue my machine has eight core. You should not set <tt class="docutils literal"><span class="pre">n_cpus</span></tt> higher than the number of
core your machine has, becasue you don&#8217;t get any speed up.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Tutorial</a><ul>
<li><a class="reference internal" href="#first-example-how-to-process-an-image-pair">First example: how to process an image pair</a></li>
<li><a class="reference internal" href="#second-example-how-to-process-in-batch-a-list-of-image-pairs">Second example: how to process in batch a list of image pairs.</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="developers.html"
                        title="previous chapter">Information for developers and contributors</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="api_reference.html"
                        title="next chapter">API reference</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/src/tutorial.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="api_reference.html" title="API reference"
             >next</a> |</li>
        <li class="right" >
          <a href="developers.html" title="Information for developers and contributors"
             >previous</a> |</li>
        <li><a href="../index.html">OpenPiv v1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, The OpenPiv Contributors.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>